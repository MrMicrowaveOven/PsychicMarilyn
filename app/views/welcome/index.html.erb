<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>The Marvelous Marilyn</title>
    <!-- icon in the highest resolution we need it for -->
    <link rel="icon" sizes="192x192" href="icon.png">
    <!-- reuse same icon for Safari -->
    <link rel="apple-touch-icon" href="ios-icon.png">
    <!-- multiple icons for IE -->
    <meta name="msapplication-square310x310logo" content="icon_largetile.png">
  </head>
  <body>
    <div id="marilyn"></div>
    <div id="data"></div>
    <script type="text/javascript">
      IDEAL_TIME_IMAGE = 'https://78.media.tumblr.com/c74eeac6d5579d55f614a7dcac4fba66/tumblr_p5eui8CWjD1v497yzo2_1280.jpg'
      SOON_TIME_IMAGE = 'https://78.media.tumblr.com/51920820d8dbec7cdf7c13963b63602e/tumblr_p5eui8CWjD1v497yzo3_1280.jpg'
      NOT_IDEAL_TIME_IMAGE = 'https://78.media.tumblr.com/920f9eb8e77bbf31fc8782bdd85a687a/tumblr_p5eui8CWjD1v497yzo1_540.jpg'

      var bartUrl = 'http://api.bart.gov/api/etd.aspx?key=MW9S-E7SL-26DU-VV8V&json=y&cmd=etd&orig=12TH&plat=2'
      $.get(bartUrl, function(data) {
        var etds = data.root.station[0].etd;
        relevantTrains = etds.filter(function(train) {
          return train.abbreviation == "MLBR" || train.abbreviation == "SFIA";
        })
        // console.log(relevantTrains);
        var minutesToArrivals = relevantTrains[0].estimate.map(function(estimate) {
          return parseInt(estimate.minutes);
        })
        var minutesToNextReasonableArrival;
        minutesToArrivals.forEach(function(arrival) {
          if (arrival < 8) {
            return;
          }
          minutesToNextReasonableArrival = minutesToNextReasonableArrival || arrival;
        })
        console.log(minutesToNextReasonableArrival);

        if (!minutesToNextReasonableArrival || minutesToNextReasonableArrival > 13) {
          marilynImage = NOT_IDEAL_TIME_IMAGE
        } else if (minutesToNextReasonableArrival >= 11) {
          marilynImage = SOON_TIME_IMAGE
        } else if (minutesToNextReasonableArrival >= 8) {
          marilynImage = SOON_TIME_IMAGE
        }

        $('#marilyn').html('<img src="' + marilynImage + '" width="100%"/>')

        var dataTable = ""
        relevantTrains.forEach(function(route) {
          dataTable += route.destination + "<br><ul>"
          route.estimate.forEach(function(estimatedArrival) {
            dataTable += "<li>" + estimatedArrival.minutes + " minutes, " + estimatedArrival.length + " car train</li>"
          })
          dataTable += "</ul>"
        })
        $('#data').html(dataTable)
      })
    </script>
  </body>
</html>
